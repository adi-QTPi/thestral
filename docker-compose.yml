# for dev purposes, checkout the prod compose on github.com/adi-QTPi/homelab-rubie

services:
  thestral:
    image: adiqtpi/thestral:dev
    container_name: thestral-dev
    network_mode: host
    restart: unless-stopped
    
    # strip out the root privileges
    cap_drop:
      - ALL
    # allow to bind on port 80/443
    cap_add:
      - NET_BIND_SERVICE

    deploy:
      resources:
        limits:
          cpus: '0.80'
          memory: 128M
        reservations:
          memory: 32M
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # make a .env file with all the necessary variables
    environment:    
      # The public listener address for the Reverse Proxy service.
      # Defaults to port 80 on all interfaces (0.0.0.0) so it is publicly accessible.
      # Usage: Change this in .env if you need to bind to a specific IP or port (e.g., :8080).
      - PROXY_BIND=${PROXY_BIND:-0.0.0.0:80}

      # The PRIVATE listener address for the Admin API & Dashboard.
      # CRITICAL: This is mandatory. You must provide a secure IP (like your Tailscale IP)
      # to ensure the admin panel is never exposed to the public internet.
      - "ADMIN_BIND=${ADMIN_BIND:?err: provide the tailnet secure endpoint (tailscale ip:port)}"

      # Database connection string (DSN).
      # Format: "host=hogwarts user=admin password=password dbname=thestral port=5433 sslmode=disable TimeZone=UTC"
      
      # use this to spin up new db container
      # docker run -d --name thestral-dev-db -e POSTGRES_USER=admin -e POSTGRES_PASSWORD="password" -e POSTGRES_DB="thestral" -p 5433:5432 postgres:15-alpine  
      
      # REQUIRED: The container will refuse to start without this.
      - "DATABASE_URL=${DATABASE_URL:?err: DSN is required for DB connection}"

      - GIN_MODE=${GIN_MODE:-release} 
      - DEBUG=${DEBUG:-false}
      - ENABLE_TLS=${ENABLE_TLS:-false}
      - RATE_LIMIT_REQ_PER_SEC=${RATE_LIMIT_REQ_PER_SEC:-1}
      - RATE_LIMIT_BURST=${RATE_LIMIT_BURST:-5}

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://${ADMIN_BIND}/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
